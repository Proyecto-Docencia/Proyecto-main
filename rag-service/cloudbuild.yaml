steps:
  # Construir la imagen Docker
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/backend-repo/${_SERVICE_NAME}:latest'
      - '.'

  # Subir imagen a Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/backend-repo/${_SERVICE_NAME}:latest']

  # Desplegar a Cloud Run con GPU
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/backend-repo/${_SERVICE_NAME}:latest'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '8080'
      - '--timeout'
      - '600s'
      - '--memory'
      - '${_MEMORY}'
      - '--cpu'
      - '${_CPU}'
      - '--gpu'
      - '1'
      - '--gpu-type'
      - 'nvidia-l4'
      - '--no-cpu-throttling'
      - '--min-instances'
      - '${_MIN_INSTANCES}'
      - '--max-instances'
      - '${_MAX_INSTANCES}'
      - '--set-env-vars'
      - 'RAG_USE_GPU=${_RAG_USE_GPU},RAG_MODEL_SENTENCE=${_RAG_MODEL_SENTENCE},RAG_TOP_K=${_RAG_TOP_K},RAG_MIN_SCORE=${_RAG_MIN_SCORE},RAG_EMBED_CACHE=${_RAG_EMBED_CACHE}'

substitutions:
  _SERVICE_NAME: 'rag-service'
  _REGION: 'us-central1'
  _MEMORY: '32Gi'
  _CPU: '8'
  _MIN_INSTANCES: '1'  # ⚡ OPTIMIZACIÓN: Mantener 1 instancia caliente
  _MAX_INSTANCES: '3'
  _RAG_USE_GPU: '1'
  _RAG_MODEL_SENTENCE: 'BAAI/bge-large-en-v1.5'  # 63.7% MTEB, 3.5GB GPU
  _RAG_TOP_K: '10'  # Aumentado para mejor cobertura
  _RAG_MIN_SCORE: '0.70'  # Más estricto: solo resultados muy relevantes (antes 0.45)
  _RAG_EMBED_CACHE: '/app/rag_cache/embeddings.npz'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: 3600s
